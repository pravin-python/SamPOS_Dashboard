{% extends 'layouts/base.html' %}
{% load static %}
{% block title %}
  Subscriptions
{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" integrity="sha512-t7Few9xlddEmgd3oKZQahkNI4dS6l80+eGEzFQiqtyVYdvcSG2D3Iub77R20BdotfRPA9caaRkg1tyaJiPmO0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- ======================================= -->
  <!-- == SUBSCRIPTIONS PAGE == -->
  <!-- ======================================= -->
  <div class="page-content">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold">Subscription Plans</h2>
      <button data-modal-target="add-plan" class="modal-trigger flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add New Plan</button>
    </div>

    <!-- Plans Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="subscriptionContainer" ></div>

  <template id="modal-template-add-plan">
    <form class="space-y-4" id="add-new-plan-form">
      {% csrf_token  %}
        <div>
            <label for="plan-name" class="block text-sm font-medium mb-1">Plan Name</label>
            <input type="text" name="name" id="plan-name" placeholder="e.g., Premium" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border border-transparent focus:border-blue-500 focus:ring-blue-500 focus:outline-none">
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="plan-price" class="block text-sm font-medium mb-1">Price</label>
                <input type="number" name="amount" id="plan-price" placeholder="49.99" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border border-transparent focus:border-blue-500 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
                <label for="plan-interval" class="block text-sm font-medium mb-1">Interval</label>
                <select id="plan-interval" name="duration" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border border-transparent focus:border-blue-500 focus:ring-blue-500 focus:outline-none">
                  {% for value, label in duration_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
            </div>
        </div>
        <div>
            <label for="plan-features" class="block text-sm font-medium mb-1">Features (one per line)</label>
            <textarea id="plan-features" name="features" rows="4" placeholder="Feature 1&#10;Feature 2&#10;Feature 3" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border border-transparent focus:border-blue-500 focus:ring-blue-500 focus:outline-none"></textarea>
        </div>
    </form>
  </template>

{% endblock %}

{% block extrascript %}
<script>
  const delModalBody = document.querySelector('#del-modal-container')
  const delModalConfirmBtn = document.querySelector('#del-modal-confirm-btn')
  const delModalCloseBtn = document.querySelector('#del-modal-close-btn')
  const delModalCancelBtn = document.querySelector('#del-modal-cancel-btn')

  const delModalBox = document.querySelector('#del-modal-box')

  // delModalCloseBtn.addEventListener('click', openDeleteModal )

  const closeDeleteModal = () => {
    delModalBody.classList.add('hidden');

    setTimeout(() => {
        delModalBox.classList.add('scale-95', 'opacity-0');
        delModalBox.classList.remove('scale-100', 'opacity-100');
    }, 10);
  }

  const openDeleteModal = (itemName, id, delmethod) =>{

     delModalBody.classList.remove('hidden');
     delModalConfirmBtn.dataset.id = id
     delModalConfirmBtn.onclick = delmethod

     // Trigger transition
     setTimeout(() => {
         delModalBox.classList.remove('scale-95', 'opacity-0');
         delModalBox.classList.add('scale-100', 'opacity-100');
     }, 10);
 };

 const deleteRecord = () => {

 }

 delModalCloseBtn.addEventListener('click', closeDeleteModal)
 delModalCancelBtn.addEventListener('click', closeDeleteModal)

 window.openDeleteModal = openDeleteModal
  const SaveUrl  = "{% url 'core:subscription-subscription-save' %}";
  let subscriptions = [];
  async function fetchAllData() {
    try {
      const response = await fetch("{% url 'core:subscription-subscription-lists' %}", {
          method: 'GET',
          headers: {
              'X-API-Key': '{{APIKEY}}'
          }
      });
        const result = await response.json();

        if (!result.status || !Array.isArray(result.data)) return;

        const container = document.getElementById('subscriptionContainer');
        container.innerHTML = "";

        result.data.forEach(plan => {
            const featuresHtml = plan.features
                .split("\n")
                .map(f => f.trim())
                .filter(f => f.length > 0)
                .map(f => `
                    <li class="flex items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="check-circle" class="lucide lucide-check-circle w-5 h-5 text-green-500 mr-2"><path d="M21.801 10A10 10 0 1 1 17 3.335"></path><path d="m9 11 3 3L22 4"></path></svg>
                        <i data-lucide="check-circle" class="w-5 h-5 text-green-500 mr-2"></i> ${f}
                    </li>
                `)
                .join("");

            const statusBtnText = plan.status === "active" ? "Deactivate Plan" : "Activate Plan";
            const statusBtnClass = plan.status === "active"
                ? "bg-red-600 hover:bg-red-700"
                : "bg-green-600 hover:bg-green-700";

            const card = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 flex flex-col items-center text-center">
                    <h3 class="text-lg font-semibold text-gray-500 dark:text-gray-400 uppercase">${plan.name}</h3>
                    <div class="my-4">
                        <span class="text-5xl font-bold">$${plan.amount}</span>
                        <span class="text-gray-500 dark:text-gray-400"></span>
                    </div>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">Plan Duration: ${plan.duration} Days</p>

                    <ul class="space-y-3 mb-8 w-full">
                        ${featuresHtml}
                    </ul>

                    <div class="flex justify-between items-center w-full">
                        <div class="flex gap-2">
                            <button class="delete-trigger border border-red-500 text-red-500 hover:bg-red-500 hover:text-white px-3 py-1 rounded text-sm"
                                    >
                                <i class="bi bi-trash"></i>
                            </button>

                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"
                                    onclick="editPlan(${plan.id})">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </div>

                        <button class="${statusBtnClass} text-white px-3 py-1 rounded text-sm"
                                onclick="toggleStatus(${plan.id})">
                            ${statusBtnText}
                        </button>
                    </div>
                </div>
            `;
            subscriptions = result.data;

            container.insertAdjacentHTML("beforeend", card);
        });
        const deleteTriggers = document.querySelectorAll('.delete-trigger');
        deleteTriggers.forEach((trigger, index) => {
            trigger.addEventListener('click', () => {
                const itemName = trigger.dataset.itemName || 'this item';
                openDeleteModal(itemName, subscriptions[index].id, deletePlan);
            });
        });

    } catch (error) {
        console.error("API Fetch Error:", error);
    }
}

document.addEventListener("DOMContentLoaded", function () {
    fetchAllData();
});


// Placeholder Functions
async function deletePlan(e) {
  const id = e.target.dataset.id;

  try {
      const response = await fetch(`/api/subscription/${id}/delete/`, {
          method: 'DELETE',
          headers: {
              'X-API-Key': '{{APIKEY}}'
          },
          credentials: "include",
      });

      const result = await response.json();

      if (result.status) {
          fetchAllData();
      }
  } catch (error) {
      console.error("API Fetch Error:", error);
  }
  closeDeleteModal()
}

function editPlan(id) {

    const templateId = 'add-plan';
    const title = 'Add New Plan';
    const subscription = subscriptions.filter(sub => sub.id == id)[0]
    openModal(templateId, title);

    const form = document.querySelector('#add-new-plan-form')
    const name = form.querySelector('[name="name"]')
    const amount = form.querySelector('[name="amount"]')
    const duration = form.querySelector('[name="duration"]')
    const features = form.querySelector('[name="features"]')
    const hiddenInput = document.createElement('input')
    hiddenInput.type = 'hidden'
    hiddenInput.name = 'id'
    hiddenInput.value = id
    form.appendChild(hiddenInput)
    name.value = subscription.name
    amount.value = subscription.amount
    duration.value = subscription.duration
    features.value = subscription.features
}

async function toggleStatus(id) {
    try {
        const response = await fetch(`/api/subscription/${id}/toggle-subscription-status/`, {
            method: 'POST',
            headers: {
                'X-API-Key': '{{APIKEY}}'
            },
            credentials: "include",
        });

        const result = await response.json();
        console.log(result);

        if (result.status) {
            fetchAllData();
        }

    } catch (error) {
        console.error("API Fetch Error:", error);
    }
}
</script>
{% endblock%}
